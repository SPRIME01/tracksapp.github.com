---
layout: post
date: 2005-02-18 
author: bsag 
title: "Lighttpd, Rails and Tracks" 
categories: [articles] 
comments: true
sharing: true
footer: true
---

<p>[Posted to both here and on <a href="http://www.rousette.org.uk/blog/">But She's a Girl...</a>]</p>

<p>Jason, of <a href="http://textdrive.com/">TextDrive</a> fame, has been <a href="http://textdrive.com/weblog/article/26/benchmarking-lighttpd">singing</a> <a href="http://textdrive.com/weblog/article/27/yep-i-would-switch">the</a> <a href="http://textdrive.com/weblog/article/31/having-ones-own-lighttpd-and-running-it-too">praises</a> of <a href="http://lighttpd.net/">lighttpd</a> recently. In my experience, when Jason sings about something techie, it's worth listening.</p>

<p>A week or so ago, the Apache installation I use to test Tracks locally abruptly stopped working. I'm pretty sure that I just messed something up in my httpd.conf, but my motivation to go through it, find the problem and fix it was seriously lacking. So given all the great press that lighttpd has been getting, I thought I'd have a go at installing it on my machine last night.</p>
 

<p>It wasn't a very difficult process, but I ended up having to try to compile it a couple of times. The first time, I neglected to notice the part of the instructions <a href="http://wiki.rubyonrails.com/rails/show/Lighttpd">here</a> that said you needed pcre installed. Then I came up against a maddening error during <code>make</code> that I couldn't fix until I came upon this <a href="http://theexciter.com/archives/2005/02/09/installing-lighttpd-1310-on-osx/">excellent tutorial</a> by Johan on installing on OS X. He found the same error as me, but had made a patch to fix the problem. Bingo? -- everything ran smoothly from then on.</p>

<p>Getting a working lighttpd.conf file was the next hurdle, but after some guidance <a href="http://bougyman.com/miscfiles/RailsonDebian.html">here</a> and a dash of trial and error, I managed to get Tracks running stably and beautifully on lighttpd. And fast. Boy, is lighttpd fast. I always found Apache to be really sluggish on my machine, but lighttpd running FCGI is really nippy and very economical on system resources.</p>

<p>So (as much for the fact that I'll probably forget what I did as anything else), here's my lighttpd.conf, set up to run a localhost install of Tracks on port 3000. At some point this weekend, I'll try setting it up for an externally-accessible configuration. The re-write rules were probably the hardest thing to sort out, but with the the advent of <a href="http://weblog.rubyonrails.com/archives/2005/02/15/routing-now-available-in-beta-gems/">Routing</a> in Rails which will make re-writing URLs a piece of cake &mdash; but more importantly, an <em>internal</em> piece of cake &mdash; so that they can be distributed inside Rails apps and will Just Work with whatever server you choose to use. I'm looking forward to that.</p>

<pre>
<code>
# lighttpd.config for Tracks on localhost, port 3000
# I put this file in /etc/lighttpd.conf, then run lighttpd with:
# % sudo /usr/local/sbin/lighttpd -f /etc/lighttpd.conf
#
# Assumes that tracks is here:
# /Users/username/Sites/tracks
#
# You also need to create the logs lighttpd.error.log and 
# lighttpd.access.log within tracks/log, as well as the directory
# ~/var/run for the PID file (this holds the PID of the currently
# running instance of lighttpd, so that you can automate stopping it).


server.modules = (
  "mod_rewrite",
# "mod_redirect",
  "mod_access",
# "mod_auth",
  "mod_status",
  "mod_fastcgi",
# "mod_simple_vhost",
# "mod_evhost",
  "mod_cgi",
# "mod_compress",
# "mod_ssi",
# "mod_usertrack",
# "mod_rrdtool",
  "mod_accesslog"
)

# You would change this to 80 for an production site
server.port = 3000
# This would be my.greatdomain.com for a production site
server.bind = "127.0.0.1"
server.pid-file = "/Users/username/var/run/lighttpd.pid"
server.document-root = "/Users/username/Sites/tracks/public"
server.errorlog = "/Users/username/Sites/tracks/log/lighttpd.error.log"
accesslog.filename = "/Users/username/Sites/tracks/log/lighttpd.access.log"

#### Visit http://127.0.0.1:3000/server-status to see lighttpd status
status.status-url = "/server-status"

# files to check for if .../ is requested
server.indexfiles = ( "index.php", "index.html", 
     "index.htm", "default.htm" )

## deny access the file-extensions
#
# ~    is for backupfiles from vi, emacs, joe, ...
# .inc is often used for code includes which should in general not be part
#      of the document-root
url.access-deny             = ( "~", ".inc" )


# You need to let Ruby handle .rb, .cgi and .fcgi files
cgi.assign = ( ".rb"  => "/usr/local/bin/ruby",
               ".cgi" => "/usr/local/bin/ruby",
               ".fcgi" => "/usr/local/bin/ruby" )

# 5 .fcgi spawns seem to work fine for a reasonable load                
fastcgi.server = ( 
  ".fcgi" =>
    ("127.0.0.1" =>
      ("socket" => "/tmp/rails.socket",
       "bin-path" => "/Users/username/Sites/tracks/public/dispatch.fcgi")
    ),
    
  ".fcgi" =>
    ("127.0.0.1" =>
      ("socket" => "/tmp/rails1.socket",
       "bin-path" => "/Users/username/Sites/tracks/public/dispatch.fcgi")
    ),
    
  ".fcgi" =>
    ("127.0.0.1" =>
      ("socket" => "/tmp/rails.socket",
       "bin-path" => "/Users/username/Sites/tracks/public/dispatch.fcgi")
    ),
    
  ".fcgi" =>
    ("127.0.0.1" =>
      ("socket" => "/tmp/rails.socket",
       "bin-path" => "/Users/username/Sites/tracks/public/dispatch.fcgi")
    ),
    
  ".fcgi" =>
    ("127.0.0.1" =>
      ("socket" => "/tmp/rails.socket",
       "bin-path" => "/Users/username/Sites/tracks/public/dispatch.fcgi")
    ),                 

# Rewriting rules. First one is the default URL for http://127.0.0.1:3000/
# Backslashes are continued lines, broken for display purposes.
url.rewrite = 
 ("^/$"   =>  "/dispatch.fcgi?controller=todo&action=list", 
         "^/([-_a-zA-Z0-9]+)/([-_a-zA-Z0-9]+)/([-_a-zA-Z0-9%]+)$" 
      => "/dispatch.fcgi?controller=$1&action=$2&id=$3", 
          "^/([-_a-zA-Z0-9]+)/([-_a-zA-Z0-9]+)$"  
      => "/dispatch.fcgi?controller=$1&action=$2")

# mimetype mapping
mimetype.assign            = (
  ".pdf"          =>      "application/pdf",
  ".sig"          =>      "application/pgp-signature",
  ".spl"          =>      "application/futuresplash",
  ".class"        =>      "application/octet-stream",
  ".ps"           =>      "application/postscript",
  ".torrent"      =>      "application/x-bittorrent",
  ".dvi"          =>      "application/x-dvi",
  ".gz"           =>      "application/x-gzip",
  ".pac"          =>      "application/x-ns-proxy-autoconfig",
  ".swf"          =>      "application/x-shockwave-flash",
  ".tar.gz"       =>      "application/x-tgz",
  ".tgz"          =>      "application/x-tgz",
  ".tar"          =>      "application/x-tar",
  ".zip"          =>      "application/zip",
  ".mp3"          =>      "audio/mpeg",
  ".m3u"          =>      "audio/x-mpegurl",
  ".wma"          =>      "audio/x-ms-wma",
  ".wax"          =>      "audio/x-ms-wax",
  ".ogg"          =>      "audio/x-wav",
  ".wav"          =>      "audio/x-wav",
  ".gif"          =>      "image/gif",
  ".jpg"          =>      "image/jpeg",
  ".jpeg"         =>      "image/jpeg",
  ".png"          =>      "image/png",
  ".xbm"          =>      "image/x-xbitmap",
  ".xpm"          =>      "image/x-xpixmap",
  ".xwd"          =>      "image/x-xwindowdump",
  ".css"          =>      "text/css",
  ".html"         =>      "text/html",
  ".htm"          =>      "text/html",
  ".js"           =>      "text/javascript",
  ".asc"          =>      "text/plain",
  ".c"            =>      "text/plain",
  ".conf"         =>      "text/plain",
  ".text"         =>      "text/plain",
  ".txt"          =>      "text/plain",
  ".dtd"          =>      "text/xml",
  ".xml"          =>      "text/xml",
  ".mpeg"         =>      "video/mpeg",
  ".mpg"          =>      "video/mpeg",
  ".mov"          =>      "video/quicktime",
  ".qt"           =>      "video/quicktime",
  ".avi"          =>      "video/x-msvideo",
  ".asf"          =>      "video/x-ms-asf",
  ".asx"          =>      "video/x-ms-asf",
  ".wmv"          =>      "video/x-ms-wmv"
 )
# Use the "Content-Type" extended attribute to obtain mime type if possible
# mimetypes.use-xattr = "enable"
</code>
</pre> 
